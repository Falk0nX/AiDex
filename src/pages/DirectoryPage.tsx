import { useEffect, useMemo, useState } from 'react';
import { apiGet, apiPost } from '../lib/api';
type Pricing = 'Free' | 'Paid' | 'Freemium' | 'Open Source';
type Tool = { id:number; name:string; website_url:string; description:string; category:string; tags:string; pricing:Pricing; is_open_source:boolean; date_added:string; };
function classNames(...xs: Array<string | false | undefined>) { return xs.filter(Boolean).join(' '); }
export default function DirectoryPage() {
  const [tools,setTools]=useState<Tool[]>([]); const [loading,setLoading]=useState(true); const [error,setError]=useState<string|null>(null);
  const [query,setQuery]=useState(''); const [category,setCategory]=useState('All'); const [pricing,setPricing]=useState<'All'|Pricing>('All'); const [openSourceOnly,setOpenSourceOnly]=useState(false); const [sort,setSort]=useState<'newest'|'name'>('newest');
  const [name,setName]=useState(''); const [websiteUrl,setWebsiteUrl]=useState(''); const [submitPricing,setSubmitPricing]=useState<Pricing>('Free'); const [submitCategory,setSubmitCategory]=useState('AI Education'); const [description,setDescription]=useState(''); const [tags,setTags]=useState(''); const [submitState,setSubmitState]=useState<'idle'|'sending'>('idle'); const [submitMessage,setSubmitMessage]=useState<string|null>(null);
  useEffect(()=>{(async()=>{try{const res=await apiGet<{ok:true;items:Tool[]}>('/api/get_tools.php');setTools(res.items||[]);}catch(e:any){setError(e.message||'Failed to load tools');}finally{setLoading(false);}})();},[]);
  const categories=useMemo(()=>{const s=new Set<string>(); tools.forEach(t=>s.add(t.category)); return ['All',...Array.from(s).sort((a,b)=>a.localeCompare(b))];},[tools]);
  const filtered=useMemo(()=>{const q=query.trim().toLowerCase(); let list=tools.filter(t=>{const tagsList=(t.tags||'').split(',').map(x=>x.trim()).filter(Boolean); const matchesQ=!q||t.name.toLowerCase().includes(q)||t.description.toLowerCase().includes(q)||tagsList.some(tag=>tag.toLowerCase().includes(q)); const matchesCategory=category==='All'||t.category===category; const matchesPricing=pricing==='All'||t.pricing===pricing; const matchesOS=!openSourceOnly||t.is_open_source; return matchesQ&&matchesCategory&&matchesPricing&&matchesOS;}); list=[...list].sort((a,b)=>sort==='name'?a.name.localeCompare(b.name):new Date(b.date_added).getTime()-new Date(a.date_added).getTime()); return list;},[tools,query,category,pricing,openSourceOnly,sort]);
  const onSubmit=async(e:React.FormEvent)=>{e.preventDefault();setSubmitMessage(null);setSubmitState('sending');try{await apiPost('/api/submit.php',{name,website_url:websiteUrl,description,category:submitCategory,pricing:submitPricing,tags});setSubmitMessage('Submitted for admin review.');setName('');setWebsiteUrl('');setDescription('');setTags('');setSubmitPricing('Free');}catch(err:any){setSubmitMessage(err.message||'Submission failed');}finally{setSubmitState('idle');}};
  return <div className="min-h-screen bg-neutral-950 text-neutral-50"><header className="border-b border-neutral-800"><div className="mx-auto max-w-6xl px-4 py-6"><h1 className="text-3xl font-semibold tracking-tight">AiDex</h1><p className="mt-2 text-sm text-neutral-300">Curated AI tools directory with admin-approved submissions.</p><div className="mt-6 grid gap-3 md:grid-cols-12"><div className="md:col-span-5"><label className="text-xs text-neutral-400">Search</label><input value={query} onChange={(e)=>setQuery(e.target.value)} className="mt-1 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm"/></div><div className="md:col-span-3"><label className="text-xs text-neutral-400">Category</label><select value={category} onChange={(e)=>setCategory(e.target.value)} className="mt-1 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm">{categories.map(c=><option key={c} value={c}>{c}</option>)}</select></div><div className="md:col-span-2"><label className="text-xs text-neutral-400">Pricing</label><select value={pricing} onChange={(e)=>setPricing(e.target.value as any)} className="mt-1 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm"><option value="All">All</option><option>Free</option><option>Freemium</option><option>Paid</option><option>Open Source</option></select></div><div className="md:col-span-2"><label className="text-xs text-neutral-400">Sort</label><select value={sort} onChange={(e)=>setSort(e.target.value as any)} className="mt-1 w-full rounded-lg border border-neutral-800 bg-neutral-900 px-3 py-2 text-sm"><option value="newest">Newest</option><option value="name">Name</option></select></div><div className="md:col-span-12 flex items-center justify-between"><label className="inline-flex items-center gap-2 text-sm text-neutral-300"><input type="checkbox" checked={openSourceOnly} onChange={(e)=>setOpenSourceOnly(e.target.checked)}/> Open-source only</label><div className="text-xs text-neutral-400">{filtered.length} result(s)</div></div></div></div></header><main className="mx-auto max-w-6xl px-4 py-8">{loading&&<p className="text-sm text-neutral-400">Loading tools…</p>}{error&&<p className="text-sm text-red-300">{error}</p>}<div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">{filtered.map(t=><article key={t.id} className="rounded-xl border border-neutral-800 bg-neutral-900 p-4"><div className="flex items-start justify-between gap-3"><div><h2 className="text-base font-semibold">{t.name}</h2><p className="mt-1 text-sm text-neutral-300">{t.description}</p></div><span className={classNames('rounded-full border px-2 py-1 text-xs',t.pricing==='Free'&&'border-emerald-700/50 text-emerald-300',t.pricing==='Paid'&&'border-amber-700/50 text-amber-300',t.pricing==='Freemium'&&'border-sky-700/50 text-sky-300',t.pricing==='Open Source'&&'border-fuchsia-700/50 text-fuchsia-300')}>{t.pricing}</span></div><div className="mt-3 flex flex-wrap gap-2"><span className="rounded-full border border-neutral-800 bg-neutral-950 px-2 py-1 text-xs text-neutral-300">{t.category}</span>{(t.tags||'').split(',').map(tag=>tag.trim()).filter(Boolean).slice(0,3).map(tag=><span key={tag} className="rounded-full border border-neutral-800 bg-neutral-950 px-2 py-1 text-xs text-neutral-400">#{tag}</span>)}</div><div className="mt-4 flex items-center justify-between"><span className="text-xs text-neutral-500">Added {new Date(t.date_added).toLocaleDateString()}</span><a href={t.website_url} target="_blank" rel="noopener noreferrer nofollow" className="text-sm underline">Visit →</a></div></article>)}</div><section id="submit" className="mt-12 rounded-2xl border border-neutral-800 bg-neutral-900 p-6"><h3 className="text-lg font-semibold">Submit a tool</h3><p className="mt-1 text-sm text-neutral-300">Submissions go into admin review.</p><form className="mt-4 grid gap-3 md:grid-cols-3" onSubmit={onSubmit}><input required value={name} onChange={(e)=>setName(e.target.value)} placeholder="Tool name" className="rounded-lg border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm"/><input required value={websiteUrl} onChange={(e)=>setWebsiteUrl(e.target.value)} placeholder="Website URL" className="rounded-lg border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm"/><select value={submitPricing} onChange={(e)=>setSubmitPricing(e.target.value as Pricing)} className="rounded-lg border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm"><option>Free</option><option>Freemium</option><option>Paid</option><option>Open Source</option></select><input value={submitCategory} onChange={(e)=>setSubmitCategory(e.target.value)} placeholder="Category" className="rounded-lg border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm"/><input value={tags} onChange={(e)=>setTags(e.target.value)} placeholder="Tags (comma-separated)" className="md:col-span-2 rounded-lg border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm"/><textarea required value={description} onChange={(e)=>setDescription(e.target.value)} placeholder="Short description" rows={3} className="md:col-span-3 rounded-lg border border-neutral-800 bg-neutral-950 px-3 py-2 text-sm"/><button disabled={submitState==='sending'} className="md:col-span-3 rounded-lg bg-white px-4 py-2 text-sm font-medium text-neutral-950 hover:bg-neutral-200 disabled:opacity-50">{submitState==='sending'?'Submitting…':'Submit for review'}</button></form>{submitMessage&&<p className="mt-3 text-sm text-neutral-300">{submitMessage}</p>}</section></main></div>;
}
